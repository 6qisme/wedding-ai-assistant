ADR-001：後端架構與安全重構
狀態：已接受

日期：2025年9月16日

1. 背景 (Context)
在初始 MVP 版本完成後，我在測試中發現了兩個關鍵的、不可接受的缺陷。首先，我最初採用的同步架構 (v7.1) 在呼叫耗時的 OpenAI API 時，會引發頻繁的請求超時 (timeout)，導致服務極不可靠。其次，在我進行安全審查時，我發現敏感的個人身份資訊 (PII) 被硬編碼在原始碼中，並暴露於公開的 Git 歷史紀錄，構成了嚴重的隱私漏洞。為了將專案提升至專業的、可供開源的標準，我決定必須執行一次涵蓋可靠性與安全性的重大重構。

2. 決策 (Decision)
我決定對後端執行一次全面的、分為兩部分的重構：

架構演進 (v7.1 -> v7.3)：我進行了一次迭代式的架構重構以解決超時問題。

首先，我將架構轉向了純非同步模型 (v7.2)，以實現對 Webhook 的即時回應，並將 AI 任務放到背景處理。

然而，我意識到這卻引入了在背景中才驗證簽章的新安全漏洞。

最終，我敲定了混合式非同步架構 (v7.3)，它在 Webhook 入口處執行同步、即時的簽章驗證，僅將合法的、耗時的任務分派到背景。

資料安全重構 (v7.4)：為了消除 PII 暴露的風險，我執行了一個雙軌並行的緊急應變計畫。

資料與程式碼解耦：所有 PII 都從原始碼移至一個外部的 config.json 檔案，並透過 .gitignore 將其排除在版本控制之外。

重建 Git 歷史：為確保不留下任何 PII 的痕跡，我執行了一次徹底的倉庫重建，清除了所有過往的 commit 歷史，並用僅包含安全、重構後程式碼的版本重新初始化了倉庫。

3. 替代方案 (Alternatives Considered)
關於架構：我曾考慮使用更複雜的任務佇列系統如 Celery，但為了 MVP 的簡潔性，最終選擇了 FastAPI 內建的 BackgroundTasks。

關於安全：我曾考慮使用 git filter-branch 等工具來清理歷史，但對於單人開發專案，一個乾淨的倉庫重建被認為是更簡單、更萬無一失的方案。

4. 後果 (Consequences)
正面影響：

應用程式透過混合式非同步架構，解決了 timeout 問題，提升了系統的可靠性。

透過將 PII 外部化並重建 Git 歷史，徹底解決了資料外洩的風險，確保了專案的安全性。

新的架構具備更高的可維護性與擴展性，並將所有關鍵的權衡與決策過程記錄於此 ADR 中。

負面影響：

專案初期的詳細迭代 commit 歷史被永久刪除。這份整合的 ADR 現在將作為這些關鍵決策的官方歷史紀錄。